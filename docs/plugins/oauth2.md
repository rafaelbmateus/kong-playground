# OAuth2

https://docs.konghq.com/hub/kong-inc/oauth2/

## Setup

1. Create a service to use oauth2 authentication:

```
curl -i -s -X POST http://localhost:8001/services \
  --data name=oauth2_service \
  --data url='http://mockbin.org' | jq
```

2. Create routes:

```console
curl -i -X POST http://localhost:8001/services/oauth2_service/routes \
  --data 'paths[]=/mock' \
  --data name=oauth2_route
```

## Enable OAuth2 Plugin

```console
curl -X POST http://localhost:8001/services/oauth2_service/plugins \
  --data "name=oauth2" \
  --data "config.scopes=email" \
  --data "config.scopes=phone" \
  --data "config.scopes=address" \
  --data "config.mandatory_scope=true" \
  --data "config.provision_key=<autogenerated>" \
  --data "config.enable_authorization_code=true" | jq
```

## Create a consumer

```console
curl -X POST http://localhost:8001/consumers/ \
  --data "username=user123" \
  --data "custom_id=SOME_CUSTOM_ID" | jq
```

## Create OAuth2

```
curl -X POST http://localhost:8001/consumers/user123/oauth2 \
  --data "name=Test%20Application" \
  --data "client_id=my-client-id" \
  --data "client_secret=5a65ebd7-1484-4e12-abf5-33de0c365035" \
  --data "redirect_uris=http://some-domain/endpoint/" \
  --data "hash_secret=true" | jq
```

## OAuth2 Flows

### Client credentials

Using URL Encode:

```
curl -X POST 'http://localhost:8001/oauth2/token' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'client_id=my-client-id' \
  --data-urlencode 'client_secret=5a65ebd7-1484-4e12-abf5-33de0c365035' \
  --data-urlencode 'grant_type=client_credentials'
```

Using json:

```console
curl -i -X POST 'http://localhost:8001/oauth2/token' \
  --header 'Content-Type: application/json' \
  --data-raw '{ "client_id": "my-client-id", "client_secret": "5a65ebd7-1484-4e12-abf5-33de0c365035", "grant_type": "client_credentials" }'
```
